---
layout: post
title: "CPU"
subtitle: "关于物理CPU，物理核，逻辑CPU，超线程的理解"
date: 2019-12-20 14:00:00
author: "Randle"
catalog: true
mathjax: false
comments: true
tags:
    - CPU
    - 超线程
---

# CPU
**物理CPU**

物理CPU是相对于虚拟CPU而言的概念，指实际存在的处理器,就是我们可以看的见，摸得着的CPU，就是插在主板上面的。如下图：
![](/img/20191220-cpu/cpu.png)

**物理核**

物理核是CPU中包含的物理内核个数，比如我们通常说的双核CPU，单核CPU。这个呢有点看不见摸不着，已经集成在CPU内部了。在linux系统下面的/proc/cpuinfo文件的条目中：1.有多少个不同的physical id就有多少个物理CPU。2.cpu cores记录了对应的物理CPU（以该条目中的physical id标识）有多少个物理核，现在我们个人使用的单机PC大部分使用的都是双核CPU。

**逻辑CPU（逻辑核）**

逻辑CPU（逻辑核）：用Intel的超线程技术(HT)将物理核虚拟而成的逻辑处理单元,现在大部分的主机的CPU都在使用HT技术，我们在windows系统下面看下图，我们看到有4个cpu记录，其实我们使用的双核CPU只是使用HT技术虚拟出来4个逻辑CPU.在linux系统下面的`/proc/cpuinfo`文件的条目中`siblings`记录了对应的物理CPU（以该条目中的physical id标识）有多少个逻辑核。
![](/img/20191220-cpu/windows.png)

**虚拟CPU**

vCPU:虚拟cpu是我们在做虚拟化时候，利用虚拟化技术，虚拟出来的CPU。讨论vCPU离不开VM，因此vCPU的讨论都是在虚拟化时候，划分cpu才会讨论的问题。通常一个物理CPU按照1:4——1：10的比例划分，假如我们有4个8物理核心的CPU按照1:5的比例划分，可以得到4X8X5=160vCPU.

# 超线程

超线程是 Intel 所研发的一种技术，于2002年发布。超线程的英文是HT技术，全名为Hyper-Threading，中文又名超线程。超线程技术原先只应用于Intel Xeon处理器中，当时称为 Super-Threading。之后陆续应用在 Pentium 4 中，将技术主流化。

通常来说，超线程功能在BIOS里是默认开启的，如果你CPU支持超线程，则会自动模拟为物理核心X2；如果超线程没有开启，可以在开机的时候，进入BIOS里，找 Hyper-Threading 项，改为enabled就是开启超线程。

英特尔表示，超线程技术让(P4)处理器增加5%的裸晶面积，就可以换来15%~30%的效能提升。但实际上，在某些程序或未对多线程编译的程序而言，超线程反而会降低效能。除此之外，超线程技术亦要操作系统的配合，普通支持多处理器技术的系统亦未必能充分发挥该技术。例如 Windows 2000，英特尔并不鼓励使用者在此系统中利用超线程。原先不支持多核心的 Windows XPHome Edition 却支持超线程技术。

## 工作原理

尽管提高 CPU 的时钟频率和增加缓存容量后的确可以改善性能，但这样的 CPU 性能提高在技术上存在较大的难度。实际上在应用中基于很多原因，CPU 的执行单元都没有被充分使用。如果 CPU 不能正常读取数据(总线/内存的瓶颈)，其执行单元利用率会明显下降。另外就是大多数执行线程缺乏ILP(Instruction-Level Parallelism，指令级别并行)支持。这些都造成了 CPU 的性能没有得到全部的发挥。因此，Intel 则采用另一个思路去提高 CPU 的性能，让 CPU 可以同时执行多重线程，就能够让 CPU 发挥更大效率，即所谓"超线程(Hyper-Threading，简称"HT")"技术。超线程技术就是利用特殊的硬件指令，把一个物理内核模拟成两个逻辑内核，让单个处理器都能使用线程级并行计算，进而兼容多线程操作系统和软件，减少了 CPU 的闲置时间，提高了 CPU 的运行速度。采用超线程即是可在同一时间里，应用程序可以使用芯片的不同部分。虽然单线程芯片每秒钟能够处理成千上万条指令，但是在任一时刻只能够对一条线程进行操作。而超线程技术可以使芯片同时进行多线程处理，使芯片性能得到提升。

超线程技术是在一颗CPU同时执行多个程序而共同分享一颗CPU内的资源，理论上要像两颗 CPU 一样在同一时间执行两个线程，P4处理器需要多加入一个 Logical CPU Pointer(逻辑处理单元)。因此新一代的P4 HT的die的面积比以往的P4增大了5%。而其余部分如ALU(整数运算单元)、FPU(浮点运算单元)、L2 Cache(二级缓存)则保持不变，这些部分是被分享的。

虽然采用超线程技术能同时执行两个线程，但它并不像两个真正的 CPU 那样，每个 CPU 都具有独立的资源。当两个线程都同时需要某一个资源时，其中一个要暂时停止，并让出资源，直到这些资源闲置后才能继续。因此超线程的性能并不等于两颗 CPU 的性能。

## 实现条件

**CPU的支持**

实现"超线程"的功能必须选购一块支持"HT"技术的处理器。Intel 支持这一技术的CPU有Core i3、Core i5、Core i7全系。在老CPU中，Pentium4 3.06GHz 、2.40C、2.60C、2.80C 、3.0GHz、3.2GHz以及Prescott处理器，还有部分型号的Xeon支持超线程技术。

**主板芯片组和主板BIOS的支持**

正式支持"HT"技术的芯片组有Intel的875P、E7205、850E、865PE/G/P、845PE/GE/GV、845G(B-stepping)、845E。其中875P、E7205、865PE/G/P、845PE/GE/GV以及最新推出的 915/925芯片组均可直接支持超线程技术的使用，而早前的845E以及850E芯片组，只要升级BIOS就可以解决支持的问题。SiS方面有SiS645DX(B版)、SiS648(B版)、SiS655、SiS658、SiS648FX。VIA方面有P4X400A、P4X600、P4X800。同时，主板的BIOS也必须支持超线程功能。

**操作系统的支持**

在微软的操作系统中只有Windows XP及以上的版本才能正式支持"超线程"技术，Windows 98/Me/2000均不支持此项功能。

**需要应用软件支持**

一般来说，只要能够支持多处理器的软件均可支持超线程技术，但是实际上这样的软件并不多，而且偏向于图形、视频处理等专业软件方面，游戏软件极少有支持的。

# 参考资料
- [物理CPU，物理核，逻辑CPU，虚拟CPU（vCPU）区别](https://www.jianshu.com/p/6903604cd1d4)
- [超线程技术](https://blog.csdn.net/baobingji/article/details/84288400)