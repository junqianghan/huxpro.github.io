---
layout: post
title: "sed"
subtitle: "Linux sed"
date: 2019-12-06 11:00:00
author: "Randle"
catalog: true
mathjax: false
comments: true
tags:
    - Linux
    - Sed
---
> `sed`，`awk` 和`grep` 被称为 Linux 三剑客，本篇记录 `sed` 的基本原理和使用方法

[TOC]
# 1. 概述

`sed` 是一种在线编辑器，它一次处理一行内容。处理时，把当前处理的行存储在临时缓冲区中，称为“模式空间”（pattern space），接着用 `sed` 命令处理缓冲区中的内容，处理完成后，把缓冲区的内容送往屏幕。接着处理下一行，这样不断重复，直到文件末尾。文件内容并没有改变，除非你使用重定向存储输出。`sed`主要用来自动编辑一个或多个文件；简化对文件的反复操作；编写转换程序等。

基本概念：
* 模式空间(pattern space)：处理文件中一行内容的一个临时缓冲区，处理完该行内容后就会把模式空间中的内容打印到标准输出，自动清空；
* 保持空间(hold space)：`sed`中的另外一个缓冲区，此缓冲区正如其名，不会自动清空，但也不会主动把此缓冲区中的内容打印到标准输出中。

# 2. 命令格式

```shell
sed [OPTION]... {script-only-if-no-other-script} [input-file]...
#或者可以理解为
sed  [options]  'AddressCommand'  file ...
```
## 2.1 Address
```shell
#first 开始，每次步长 step
0. first～step
#StartLine 到 EndLine，$ ，表示最后一行
1. StartLine，EndLine
#满足正则表达式的行
2. /RegExp/
#第一次被pattern1匹配到的行开始，至第一次被pattern2匹配到的行结束，这中间所有的行
3. /pattern1/，/pattern2/
#指定的行
4. LineNumber
#从startLine 开始，向后的 N 行
5. StartLine,+N
```
## 2.2 Options

* -n,--quiet,--silent : 抑制模式空间的自动打印 [i.e.](#o_n)
* -e script, --expression=script : 将脚本添加到要执行的命令。允许多点编辑 [i.e.](#o_e)
* -f script-file, --file=script-file : 添加脚本文件内容到将要执行的命令 [i.e.](#o_f)
* -i[SUFFIX], --in-place[=SUFFIX] : 直接修改读取的档案内容，而不是由屏幕输出 [i.e.](#o_i)
* --posix : 禁用所有的 GNU 扩展；
* -r，--regexp-extended : 在脚本中使用扩展的正则表达式; [i.e.](#o_r)
* -s，--separate : 把文件视为单独的，而不是作为一个连续的长流。[i.e.](#o_s)
* -u，--buffered : 从输入文件中加载最小量的数据，并经常刷新输出缓冲区; [i.e.](#o_u)

## 2.3 Command

- d : 删除模式空间 [i.e.](#c_d)
- p : 显示模式空间 [i.e.](#c_p)
- a \string : 在指定的行后面追加新行，内容为 string，新行 \n 可以用于换行 [i.e.](#c_a)
- i \string : 在指定的行前面添加新行，内容为 string [i.e.](#c_i)
- c \string : 替换匹配的行，内容为 string [i.e.](#c_c)

以上三个操作在模式空间，前面加，后面加，替换；

- r FILE : 将指定的文件加至符合条件的行的下一行；[i.e.](#c_r)
- R FILE : 从FILE 中读取一行追加到当前行的下一行，每次读取一行；[i.e.](#c_R)
- w FILE : 将当前模式空间的内容写入到 FILE；[i.e.](#c_w)
- W FILE : 将当前模式空间的第一行写入 FILE；[i.e.](#c_W)
- = : 打印当前行的行号;[i.e.](#c_=)
- N : 把下一行的内容提到待处理行末尾; [i.e.](#c_n)
- n : 把下一行的内容提到待处理行，并覆盖待处理行; [i.e.](#c_n)
- q : 处理完该行后退出; [i.e.](#c_q)
- Q : 到该行不处理退出; [i.e.](#c_q)
- l : 列出当前行的全部信息;[i.e.](#c_l)
- l width : 列出当前行的全部信息，如果字符长度为 width 时，那么就打断在下一行显示。这是一个GNU 扩展 [i.e.](#c_l_width)
- s/pattern/string : 默认只替换每行中第一次被模式匹配到的字符串，【pattern 代表可以使用正则表达式】
	- g: 全局替换         s/pattern/string/g【修饰符】  [i.e.](#c_s)
	- i: 忽略字符大小写   s/pattern/string/i【修饰符】
	- s///,s###,s@@@ ，三种符号'/','#','@'都能用在替换命令中 [i.e.](#c_s)
	- [\\(\）, \1, \2  分组]; [i.e.](#c_&)
	- [&  引用模式匹配整个串]; [i.e.](#c_&)

下面几个命令与模式空间和保持空间有关。[i.e.](#hold_buffer)
- h,H : Copy/append pattern space to hold space.
	- 复制/追加pattern space的内容到hold space.
- g,G : Copy/append hold space to pattern space.
	- 复制/追加hold space的内容到pattern space.
- x : Exchange the contents of the hold and pattern spaces. 
	- 交换hold space和pattern space的内容.

**Note**:！表示不执行某个命令
```shell
# sed '1!G;h;$!d' file
```
表示第 1行不执行 G，最后一行不执行 d;

# 3 Examples

## 3.1 Options

`-n,--quiet,--silent` 抑制模式空间的自动打印。<a name="o_n"></a>

```shell
$ cat sed1   
qwewq  
zhang liang  
werwet bbb  
ewtew 123  
$ sed '/bbb/p' sed1     # 打印模式空间内容和匹配内容  
qwewq  
zhang liang  
werwet bbb  
werwet bbb          # 重复内容  
ewtew 123  
$ sed -n '/bbb/p' sed1  # 不打印模式空间内容，只打印匹配内容  
werwet bbb  
```

`-e script, --expression=script`。<a name="o_e"></a>

```shell
$ cat sed1   
qwewq  
wetwdgh  
5555  
zhang liang  
werwet bbb  
ewtew 123  
ettte
$ sed -e '1,3d' sed1   
zhang liang  
werwet bbb  
ewtew 123  
ettte
# 第一个是删除1到3行，第二个是将'zhang'替换为'bing'
$ sed -e '1,3d' -e 's/zhang/bing/' sed1 
bing liang  
werwet bbb  
ewtew 123  
ettte  
```
`-f script-file, --file=script-file`。<a name="o_f"></a>

```shell
$ cat script1    # 没有引号  
1,3d            # 删除1到3行  
s/zhang/bing/   # 每行中把 zhang 替换为 bing  
/liang/p        # 行中出现liang 的打印出来
#不能使用 -n /liang/p，或者 n /liang/p。因为脚本不支持命令选项】
$ cat sed1   
qwewq  
wetwdgh  
5555  
zhang liang  
werwet bbb  
ewtew 123  
ettte  
$ sed -f ./script1 sed1   
bing liang  
bing liang  
werwet bbb  
ewtew 123  
ettte  
```
`-i[SUFFIX], --in-place[=SUFFIX]`。<a name="o_i"></a>

```shell
$ cat sed1
zhang liang
werwet bbb
$ sed -i s/bbb/liangzhuang/g sed1

$ cat sed1
zhang liang
werwet liangzhuang
```
* sed -n '3,$ {=;p}' sed1<a name="o_n"></a>

```shell
$ cat sed1          
qwewq  
wetwdgh  
5555  
zhang liang  
werwet wqeqqq  
ewtew 123  
ettte  
$ sed -n '3,$p' sed1     
5555  
zhang liang  
werwet wqeqqq  
ewtew 123  
ettte  
#打印行号
$ sed -n '3,$=' sed1
3  
4  
5  
6  
7  
$ sed -n '3,$ {=;p}' sed1     
3  
5555  
4  
zhang liang  
5  
werwet wqeqqq  
6  
ewtew 123  
7  
ettte  
#数字行的下一行提到当前行，将回车符号替换为冒号空格
$ sed -n '1,${=;p}' sed1 | sed -n '/^[0-9]*$/{N;s/\n/: /p}'       
1: qwewq  
2: wetwdgh  
3: 5555  
4: zhang liang  
5: werwet wqeqqq  
6: ewtew 123  
7: ettte  
```
## 3.2 Commands
<a name="c_a"></a>
`a \string`在指定的行后面追加新行，内容为string，`\n`可以用于换行。

```shell
$ cat sed1   
qwewq  
wetwdgh  
5555  
zhang liang  
werwet wqeqqq  
ewtew 123  
ettte  
$ sed '/^e/a \### hello World!' sed1
qwewq  
wetwdgh  
5555  
zhang liang  
werwet wqeqqq  
ewtew 123  
### hello World!  
ettte  
### hello World!  
```

`i \string`在指定的行前面添加新行，内容为string。<a name="c_i"></a>

```shell
$ sed '/^e/i \### hello World!' sed1    
qwewq  
wetwdgh  
5555  
zhang liang  
werwet wqeqqq  
### hello World!  
ewtew 123  
### hello World!  
ettte  
```
`q[exit-code] Q[exit-code]`。<a name="c_q"></a>

```shell
$ cat sed1   
qwewq  
wetwdgh  
5555  
zhang liang  
werwet wqeqqq  
ewtew 123  
ettte  
#打印第4行后退出【sed '4q12' sed1】
$ sed '4q' sed1   
qwewq  
wetwdgh  
5555  
zhang liang  
#到第4行就退出【sed '4Q12' sed1】
$ sed '4Q' sed1  
qwewq  
wetwdgh  
5555  
```
`r filename` 追加从 filename 中读取的文本。<a name="c_r"></a>

```shell
$ cat sed1   
qwewq  
wetwdgh  
5555  
zhang liang  
werwet wqeqqq  
ewtew 123  
ettte  
$ cat script1
1,3d   
s/zhang/bing/  
n /liang/p  
$ sed '/^e/r script1' sed1   
qwewq  
wetwdgh  
5555  
zhang liang  
werwet wqeqqq  
ewtew 123               # 第一次追加  
1,3d   
s/zhang/bing/  
n /liang/p  
ettte                   # 第二次追加  
1,3d   
s/zhang/bing/  
n /liang/p  
```

`R filename` 从filename 中读取一行进行追加，每次读取一行内容。<a name="c_R></a>

```shell
#请注意和 r 的区别  
$ sed '/^e/R script1' sed1    
qwewq  
wetwdgh  
5555  
zhang liang  
werwet wqeqqq  
ewtew 123            # 第一次追加  
1,3d                 # filename 的第一行  
ettte                # 第二次追加  
s/zhang/bing/        # filename 的第二行  
```
Commands which accept address ranges   命令可以接受地址范围

`c \string`替换匹配的行，内容为string。<a name="c_c"></a>

```shell
$ cat sed1   
qwewq  
wetwdgh  
5555  
zhang liang  
werwet wqeqqq  
ewtew 123  
ettte  
# 替换2到4行内容 \n 换行
$ sed '2,4 c \### kjkjkjk\nggggg' sed1   
qwewq  
### kjkjkjk  
ggggg  
werwet wqeqqq  
ewtew 123  
ettte
```

`d` 删除模式空间内容。<a name="c_d"></a>

```shell
$ cat sed1   
qwewq  
wetwdgh  
5555  
zhang liang  
werwet wqeqqq  
ewtew 123  
ettte  
$ sed '3,$ d' sed1   
qwewq  
wetwdgh  
```

`l` 列出当前行的【全部信息】 小写的【L】。<a name="c_l"></a>

```shell
$ sed -n '3,5 l' sed1   
5555$  
zhang liang$  
werwet wqeqqq$  
```

`l width` 列出当前行的全部信息，如果字符长度为 `width` 时，那么被打断在下一行显示。这是一个GNU扩展。<a name="c_l_width"></a>

```shell
# 一个空格也会算作一个字符[第10个时被打断，第10个字符在下一行显示]
$ sed -n '3,5 l 10' sed1
5555$  
zhang lia\  
ng$  
werwet wq\  
eqqq$  
```
`n/ N`读取`n`/追加`N` 下一行的输入到模式空间。<a name="c_n"></a>

```shell
$ sed -n '2,5 {n;p}' sed1    
5555  
werwet wqeqqq  
$ cat sed1   
qwewq  
wetwdgh  
5555  
zhang    liang  
werwet wqeqqq  
ewtew 123  
ettte  
```
`w filename`当前模式空间的内容写入到 filename 中。<a name="c_w"></a>
```shell
$ ll  
total 8  
-rw-rw-r-- 1 oldboy oldboy 31 Sep  4 07:40 script1  
-rw-rw-r-- 1 oldboy oldboy 64 Sep 14 23:21 sed1  
$ cat sed1   
qwewq  
wetwdgh  
5555  
zhang    liang  
werwet wqeqqq  
ewtew 123  
ettte  
$ sed -n '3,5 w ztest' sed1   
$ ll  
total 12  
-rw-rw-r-- 1 oldboy oldboy 31 Sep  4 07:40 script1  
-rw-rw-r-- 1 oldboy oldboy 64 Sep 14 23:21 sed1  
-rw-rw-r-- 1 oldboy oldboy 34 Sep 14 23:47 ztest  
$ cat ztest   
5555  
zhang    liang  
werwet wqeqqq  
```

`W filename`将当前模式空间的第一行写入filename。这是一个GNU扩展。<a name="c_W"></a>

```shell
#第3行到第5行的每一行写入文件
$ sed -n '3,5 W ztest2' sed1
$ cat ztest2  
5555  
zhang    liang  
werwet wqeqqq  
```
`s/regexp/replacement/`默认只替换每行中第一次被模式匹配到的字符串`s/pattern/string/`，`pattern` 代表可以使用正则表达式。<a name="c_s"></a>

```shell
$ cat /etc/fstab   
UUID=67be2fce-cfc2-4e9e-ae0f-47d70d2d4bad /boot                   ext4    defaults        1 2  
tmpfs                   /dev/shm                tmpfs   defaults        0 0  
devpts                  /dev/pts                devpts  gid=5,mode=620  0 0  
#这里的‘@’的作用是‘/’，只是个符号，用‘@’，‘/’都可以
$ sed 's@/@##@' /etc/fstab   
UUID=67be2fce-cfc2-4e9e-ae0f-47d70d2d4bad ##boot                   ext4    defaults        1 2  
tmpfs                   ##dev/shm                tmpfs   defaults        0 0  
devpts                  ##dev/pts                devpts  gid=5,mode=620  0 0  
$ sed 's@/@##@g' /etc/fstab   
UUID=67be2fce-cfc2-4e9e-ae0f-47d70d2d4bad ##boot                   ext4    defaults        1 2  
tmpfs                   ##dev##shm                tmpfs   defaults        0 0  
devpts                  ##dev##pts                devpts  gid=5,mode=620  0 0  
$ sed 's@u@##@g' /etc/fstab    
UUID=67be2fce-cfc2-4e9e-ae0f-47d70d2d4bad /boot                   ext4    defa##lts        1 2  
tmpfs                   /dev/shm                tmpfs   defa##lts        0 0  
devpts                  /dev/pts                devpts  gid=5,mode=620  0 0  
$ sed 's@u@##@gi' /etc/fstab    
####ID=67be2fce-cfc2-4e9e-ae0f-47d70d2d4bad /boot                   ext4    defa##lts        1 2  
tmpfs                   /dev/shm                tmpfs   defa##lts        0 0  
devpts                  /dev/pts                devpts  gid=5,mode=620  0 0  
```
`&`引用模式匹配整个串 <a name="c_&"></a>

l..e:  
like-->liker 
love-->lover  

like-->Like  
love-->Love  

```shell
$ cat sed2  
hello, like  
hi, my love  
$ sed 's/l..e/l..er/' sed2  
hello, l..er  
hi, my l..er  
#使用了&，此处的&为‘l..e’
$ sed 's/l..e/&r/' sed2      
hello, liker  
hi, my lover  
# 使用了向后引用 或者扩展正则： sed -r 's/(l..e)/\1r/' sed2
$ sed 's/\（l..e\）/\1r/' sed2
hello, liker  
hi, my lover 
```
模式空间和保持空间（pattern buffer and hold buffer）<a name="hold_buffer"></a>

```shell
$ cat file
First
Second
Three
$ sed '1!G;h;$!d' file
Three
Second
First
```



# 参考资料
- [sed高级用法：模式空间(pattern space)和保持空间(hold space)](https://blog.csdn.net/itsenlin/article/details/21129405)  
- [Linux sed 命令](https://blog.csdn.net/woshizhangliang999/article/details/48089757)

